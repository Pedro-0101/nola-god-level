version: '3.8'

services:
  # --- GERADOR DE DADOS ---
  data-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: godlevel-data-gen
    volumes:
      - .:/app
    command: >
      sh -c "
        echo 'Aplicando schema no Neon...' &&
        psql 'postgresql://neondb_owner:npg_U3HIg8fSyNYG@ep-round-credit-acfujbd5-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require' -f /app/database-schema.sql &&
        echo 'Gerando dados...' &&
        python generate_data.py --db-url 'postgresql+psycopg://neondb_owner:npg_U3HIg8fSyNYG@ep-round-credit-acfujbd5-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require'
      "
    restart: "no"

  # --- DASHBOARD STREAMLIT ---
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: godlevel-dashboard
    environment:
      DATABASE_URL: "postgresql+psycopg://neondb_owner:npg_U3HIg8fSyNYG@ep-round-credit-acfujbd5-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
      STREAMLIT_ENV: production
    ports:
      - "8501:8501"
    volumes:
      - .:/app
    command: streamlit run dashboard/Sales.py --server.port=8501 --server.address=0.0.0.0

  # --- INTERFACE PGADMIN (opcional) ---
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: godlevel-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@godlevel.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    restart: "no"
